# TCP/IP

## 1. TCP/IP 模型

TCP/IP协议模型（Transmission Control Protocol/Internet Protocol）

基于TCP/IP的参考模型，将协议分成四个层次

如下图，左边：OSI模型；右边：TCP/IP模型

![å¾çæè¿°](https://dn-simplecloud.shiyanlou.com/uid/8797/1548669082626.png-wm)

- (1)应用层：应用程序通过这一层访问网络，常见 FTP、HTTP、DNS 和 TELNET 协议；
- (2)传输层：TCP 协议和 UDP 协议等；
- (3)网络层：IP 协议，ARP、RARP 协议，ICMP 协议等；
- (4)网络接口层：是 TCP/IP 协议的基层，负责数据帧的发送和接收



发送方：每一层的数据都会经过封装（如图）

接收方：每一层的数据都会经过解包（反向）

> - 协议数据单元（PDU，Protocol Data Unit）：在发送数据时，数据在协议层次当中自上而下一层一层在首部或尾部添加的信息

![](http://img.doze9097.top//20200531004314.png)

### 1.2 传输层

### 1.3 网络层

 **MTU** （即 **最大传输单元** ）：以太网和 IEEE802.3 对数据帧长度都有限制，其最大值分别为 1500 字节和 1492 字节。

**MSS**：为MTU去掉首部之后的最大长度

当网络层传输的数据大于MTU，则会对MSS进行**分片**。

> 两种发送方式：
>
> 1. 累计数据接近MSS的大小
> 2. 超时发送

![](http://img.doze9097.top//20200531122553.png)

### 1.4 网络接口层

**物理层**负责0、1比特流与物理设备电压高低、光的闪灭之间的互换。 

**数据链路层**负责将0、1序列划分为数据帧从一个节点传输到临近的另一个节点。

这些节点是通过**MAC**来唯一标识的(MAC,物理地址，一个主机有一个MAC地址)。

![](http://img.doze9097.top//20200531131119.png)

## 2. 过程

### 2.1 总体过程

![](http://img.doze9097.top//20200531130524.png)

### 2.2 三次握手

三次握手防止已失效的连接又传到服务器端产生的错误。

例如：有客户端（Client）的连接请求由于网络原因滞留太久后又发送到服务端（Server）。该请求对于Client来说已经失效，而Server在后来又收到了该连接请求，同意建立连接，又因为Client不会理睬Server的确认连接（即不会发送后续数据），会使得Server一直等待Client发来数据，造成了Server的资源浪费。

因此需要采用三次握手，保证client和server相互确认连接状态。

![](http://img.doze9097.top//20200531003044.png)

SYN：用于对校发送数据的序号初值

seq：初始序列号

### 2.3 四次挥手

可以看到双发均发出一次请求断开信息和一次接收确认信息，这样可以确保对方收到自己“不再发送信息”的请求，防止一方有数据没有发完另一方就已经关闭连接了。

![](http://img.doze9097.top//20200531003120.png)

### 2.4 数据收发过程

初始序号是随机的，不一定是1

![](http://img.doze9097.top//20200531122910.png)

## 3. 滑动窗口

滑动窗口：是在发送一个包之后不等待ACK号返回，直接发送后续的一系列包。充分利用等待ACK号的时间。

![](http://img.doze9097.top//20200531125220.png)

为了防止处理速度不一样导致的发送过量包（发送方速度大于接收方速度，接收方不能及时处理缓冲区的数据），需要告知剩余窗口大小空间

> 窗口大小：所能接收的最大数据量

**窗口大小的更新时机**：发送方接受到接收方的窗口大小后，可以自行计算剩余大小。**当接收方从缓冲区取出数据时告知发送方窗口的大小即可**。

接收方发送ACK号和窗口更新时，不会马上发出，而会等待一段时间，用于观察是否更新ACK号（多个ACK号只需发送最后一个即可）和更新窗口的大小。可以减少所需发送的包的数量。

![](http://img.doze9097.top//20200531125409.png)



## 4. TCP和UDP

TCP和UDP都是传输层协议。运用在不同的场景。

![](http://img.doze9097.top//20200531132745.png)

![](http://img.doze9097.top//20200531133155.png)



## 5. 拥堵算法

### 5.1 慢开始 和 拥塞避免

发送方维持一个拥塞窗口cwnd（congesion window）的状态变量，并且**发送窗口大小等于拥塞窗口**。

> 拥塞窗口的大小取决于网络的拥塞程度，并且在动态变化。

发送方对拥塞窗口的控制原则是：网络没有拥塞，拥塞窗口增大。网络拥塞，则减小。

**慢开始**

发送发发送数据时，并不清楚网络的负荷情况，如果立即将大量数据注入网络，可能引起网络拥塞。

因此，较好的方法是先探测以下，发送窗口由小到大增大。

通常在刚开始发送报文时，拥塞窗口大小为一个最大报文段（MSS）。每次收到一个对新报文段的确认后，就让拥塞窗口大小变为两倍，直到累积到16倍（慢开始限度）时采用”加法增大“策略，改为每次加一个MSS

![](http://img.doze9097.top//20200531152706.png)

**拥塞避免**

当发生超时（即网络拥塞）时，拥塞避免算法会将（新开始的慢开始的门限）设置为发生过拥塞时的值的一半（如图为24，即发生超时处；设置后的上线为12，即传输次数17处）。然后将拥塞窗口大小重置为一个MSS然后重复过程。

![](http://img.doze9097.top//20200531155703.png)

### 5.2 快重传 和 快恢复

**快重传**

快重传要求接收方每收到一个**失序**的报文段后**立刻**发送重复确认（使发送方尽早知道有报文未送达），而不要等到自己发送数据时才捎带确认。

![](http://img.doze9097.top//20200531154709.png)

如上图，M1和M2的收发正常。M3丢失。接着，接收方没有收到M3而收到了M4。

按照快重传的规定，接收方及时发送对M2的重复确认，发送方虽然继续发送了M5,M6。但接收方收到后，仍对M2进行重复确认。这样，发送方一共收到接收方4个对M2的确认，其中后3为重复确认。

仍照快重传的规定，发送方只要一连收到3个重复确认就应当立即重传对方尚未收到的M3报文段，不必等待M3设置的重传计时器到期。

> 若没有快重传，接收方不能确认M4，但根据可靠传输原理，接收方可以什么都不做，也可以在适当时机发送一次对M2的确认。

由于发送方今早重传违背确认的报文段，采用快重传可以使网络的吞吐量提高越20%。

**快恢复**

与快重传配合使用，其过程有以下两个要点：

- 发送方连续收到三个重复确认，就执行“乘法减小”算法，把慢开始门限减半。
- 由于没有发生网络阻塞（阻塞就不会连续收到4个确认），因此不执行慢开始算法，**不会**将拥塞窗口设置为一个MSS而是**置为当前拥塞窗口大小的一半**，然后**实行拥塞避免算法**——即每次收到确认后+1。

![](http://img.doze9097.top//20200531155516.png)

## 6. 协议详情

### 6.1 TCP协议

![](http://img.doze9097.top//20200531004145.png)

### 6.2 IP协议

不是可靠的协议，IP协议没有提供一种数据未传达以后的处理机制。发送错误发生时，IP数据包将被抛弃。

![](http://img.doze9097.top//20200531130729.png)

![](http://img.doze9097.top//20200531130947.png)

### 6.3 UDP协议

![](http://img.doze9097.top//20200531131031.png)

### 6.4 ARP协议和RARP协议

ARP是根据IP地址获取MAC地址的一个协议。

主机自身有ARP缓存表（IP-MAC），若对应查询不存在，则会发送ARP广播包进行查询，并写入缓存表。

RARP协议工作原理与此相反，即MAC-IP。

### 6.5 ICMP协议

由于IP协议不是可靠协议。需要使用ICMP来保证数据传输。

当IP数据包发生错误，如主机不可达、路由不可达时，ICMP协议会把错误信息封包，传回主机，保证了IP层以上协议安全。

## 7. 应用层常见协议对应的端口

- SSH 22

- FTP 20 和 21

- Telnet 23

  > Internet 远程登陆服务的标准协议和主要方式
  >
  > 无法连接的原因：
  >
  > - 防火墙屏蔽
  > - 目标机器没有启用相关远程桌面服务( windows )
  > - 修改了默认端口。

- SMTP 25

- TFTP 69

- HTTP 80

- SNMP 161

- Ping 使用ICMP，无具体端口号

